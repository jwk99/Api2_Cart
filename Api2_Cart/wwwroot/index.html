<!DOCTYPE HTML>
<html lang="pl">
<head>
    <meta charset="utf-8"/>
    <title>Sklep</title>
    <style>
        body {font-family: Arial, sans-serif; margin:40px;}
        h2 {margin-top: 30px;}
        table {border-collapse: collapse; width:500px;}
        th,td {border:1px solid #ccc; padding:6px; text-align:left;}
        button {padding: 4px 8px;}
        input[type=number] {width: 60px;}
    </style>
</head>
<body>
    <h1>Sklep</h1>
    <h2>Produkty</h2>
    <table id="products">
        <thead>
            <tr>
                <th>Nazwa</th>
                <th>Cena</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <h2>Koszyk</h2>
    <table id="cart">
        <thead>
            <tr>
                <th>ID produktu</th>
                <th>Ilość</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <br />
    <button onclick="checkout()">Zamów</button>
    <script>
        const productsTable = document.querySelector("#products tbody");
        const cartTable = document.querySelector("#cart tbody");
        async function loadProducts() {
            const res = await fetch("/api/products");
            const products = await res.json();
            productsTable.innerHTML = "";
            for (const p of products) {
                productsTable.innerHTML += `
                    <tr>
                        <td>${p.name}</td>
                        <td>${p.price}</td>
                        <td>
                            <button onclick="addToCart(${p.id})">Dodaj</button>
                        </td>
                    </tr>`;    
            }
        }
        async function loadCart() {
            const res = await fetch("/api/cart");
            const cart = await res.json();
            cartTable.innerHTML = "";
            for (const item of cart) {
                cartTable.innerHTML += `
                    <tr>
                        <td>${item.productId}</td>
                        <td>
                            <input type="number" min="1" value="${item.qty}" onchange="updateQty(${item.productId}, this.value)"/>
                        </td>
                        <td>
                            <button onclick="removeItem(${item.productId})">Usuń</button>
                        </td>
                    </tr>`;
            }
        }
        async function addToCart(productId) {
            await fetch("/api/cart/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ productId, qty: 1 })
            });
            loadCart();
        }
        async function updateQty(productId, qty) {
            await fetch("/api/cart/item", {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ productId, qty: Number(qty) })
            });
            loadCart();
        }
        async function removeItem(productId) {
            await fetch(`/api/cart/item/${productId}`, {
                method: "DELETE"
            });
            loadCart();
        }
        async function checkout() {
            const res = await fetch("/api/checkout", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body:"{}"
            });
            if (!res.ok) {
                alert("Błąd podczas składania zamówienia");
                return;
            }
            if (res.status === 409) {
                alert("Koszyk jest pusty");
                return;
            }
            const result = await res.json();
            alert(`Zamówienie #${result.orderId}\nSuma: ${result.total.toFixed(2)}`);
            loadCart();
        }
        loadProducts();
        loadCart();
    </script>
</body>
</html>